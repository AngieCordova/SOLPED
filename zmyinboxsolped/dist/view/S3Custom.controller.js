sap.ui.define(["sap/m/MessageBox","sap/m/MessageToast","sap/m/UploadCollectionParameter","sap/m/VBox","sap/m/ObjectAttribute","sap/m/ObjectStatus","sap/m/Text","sap/m/Label","sap/m/library","sap/base/Log","sap/base/security/encodeURL","sap/suite/ui/commons/TimelineItem","sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/core/Fragment","sap/ui/core/mvc/XMLView","sap/ui/layout/form/FormElement","sap/ui/layout/ResponsiveFlowLayoutData","sap/ui/model/Context","sap/ui/model/json/JSONModel","cross/fnd/fiori/inbox/attachment/util/AttachmentFormatters","cross/fnd/fiori/inbox/controller/BaseController","cross/fnd/fiori/inbox/util/tools/Application","cross/fnd/fiori/inbox/util/tools/CommonHeaderFooterHelper","cross/fnd/fiori/inbox/util/ActionHelper","cross/fnd/fiori/inbox/util/Forward","cross/fnd/fiori/inbox/util/ForwardSimple","cross/fnd/fiori/inbox/util/SupportInfo","cross/fnd/fiori/inbox/util/Conversions","cross/fnd/fiori/inbox/util/Resubmit","cross/fnd/fiori/inbox/util/Parser","cross/fnd/fiori/inbox/util/ConfirmationDialogManager","cross/fnd/fiori/inbox/util/EmployeeCard","cross/fnd/fiori/inbox/util/ComponentCache","cross/fnd/fiori/inbox/util/CommonFunctions","cross/fnd/fiori/inbox/util/Utils","sap/ui/core/format/DateFormat","sap/ui/core/Component","sap/ui/core/routing/History","sap/ui/core/Core","cross/fnd/fiori/inbox/util/Constants","sap/ui/model/odata/v2/ODataModel"],function(t,e,o,r,i,s,n,a,l,u,d,f,jQuery,c,h,p,g,m,b,S,v,M,x,C,_,w,I,y,B,P,L,O,D,F,E,A,T,R,N,k,V,H){"use strict";return sap.ui.controller("customer.zmyinboxsolped.view.S3Custom",{onInit:function(){var t=this.getView();this.oModel2=new S;this.resetDetailView();t.setModel(this.oModel2,"detail");this.i18nBundle=this.getResourceBundle();t.setModel(new S({}),"solpedHeader");t.setModel(new S([]),"solpedItems");this.sResubmitUniqueId=this.createId()+"DLG_RESUBMIT";var e=this.getOwnerComponent().getEventBus();e.subscribe("cross.fnd.fiori.inbox","open_supportinfo",this.onSupportInfoOpenEvent,this);e.subscribe("cross.fnd.fiori.inbox.dataManager","taskCollectionFailed",this.onTaskCollectionFailed.bind(this));e.subscribe("cross.fnd.fiori.inbox.dataManager","showReleaseLoaderOnInfoTab",this.onShowReleaseLoaderOnInfoTab.bind(this));e.subscribe("cross.fnd.fiori.inbox.dataManager","showReleaseLoader",this.onShowReleaseLoader.bind(this));e.subscribe("cross.fnd.fiori.inbox.dataManager","UIExecutionLinkRequest",this.onShowReleaseLoader.bind(this));e.subscribe("cross.fnd.fiori.inbox.dataManager","refreshTask",function(){this.extHookOnDataLoaded()}.bind(this),this);this.oRouter=this.getOwnerComponent().getRouter();this.oRouter.attachRoutePatternMatched(this.handleNavToDetail,this);this.oRouter.attachBeforeRouteMatched(this.handleBeforeRouteMatched,this);this.oTabBar=t.byId("tabBar");var o=this.getOwnerComponent().getDataManager();if(o){var r=o.getCacheSize();this.oComponentCache=new F(r||undefined)}else{this.oComponentCache=new F}this._setExtensionState(false);t.byId("InvisibleTabStop").addEventDelegate({onsapspace:function(){var t;if(this.bShowLogs){t=this.byId("LogButtonID");if(t)this.onLogBtnPress()}else if(this.bShowDetails){t=this.byId("DetailsButtonID");if(t)this.onDetailsBtnPress()}setTimeout(function(){t&&t.focus()},300)}},this);if(!o.oServiceMetaModel){o.oModel.getMetaModel().loaded().then(function(){o.oServiceMetaModel=o.oModel.getMetaModel()}.bind(this))}this.oAppImp=x.getImpl();this.bShowLogs=false;this.bShowDetails=false},extHookOnDataLoaded:function(){try{var t=this.getView().getModel("detail");if(!t){sap.m.MessageToast.show("No se encontró el modelo 'detail'.");return}var e=t.getProperty("/TaskTitle")||"";var o=this._getKeysFromTask(e);console.log("Título:",e);console.log("BANFN extraído:",o.banfn);console.log("BNFPO extraído:",o.bnfpo);if(!o.banfn){sap.m.MessageToast.show("No se encontró Nº de SOLPED.");return}this._loadSolped(o.banfn,o.bnfpo)}catch(t){jQuery.sap.log.error("extHookOnDataLoaded error",t);sap.m.MessageBox.error("Ocurrió un error al preparar los datos de la tarea.")}},_extractSolpedFromTitle:function(t){var e=String(t||"").match(/(\d{7,10})/);return e?e[1]:""},_getSolpedFromCustomAttributes:function(){try{var t=this.getView().getModel("detail");var e=t&&t.getProperty("/CustomAttributeData");if(e){for(var o=0;o<e.length;o++){if(e[o].Name==="SOLPED"||e[o].Name==="Solped"){return e[o].Value}}}}catch(t){u.error("Error extrayendo SOLPED de CustomAttributes",t)}return""},_loadSolped:function(t,e){var o=this.getView();var r=this.getOwnerComponent().getModel("Z_MM_WF_SOLPED_SRV");if(!r){sap.m.MessageBox.error("El modelo Z_MM_WF_SOLPED_SRV no está disponible");return}var i=this._isOutboxMode();if(e){e=e.toString().padStart(5,"0")}t=this._normBanfn(t);var s=this._getBanfnPath(r,"Z_MM_WF_SOLPEDSet",t);var n="Solped eq '"+t+"'";o.setBusy(true);var a=new Promise(function(t,e){r.read(s,{success:t,error:e})});var l=new Promise(function(t,e){r.read("/EDetSet",{urlParameters:{$filter:n},success:function(e){t(e&&e.results||[])},error:e})});Promise.all([a,l]).then(function(r){var i=r[0];var s=r[1]||[];var n="Posicion";if(s.length){["Posicion","EBELP","BNFPO","Ebelp","Bnfpo"].some(function(t){if(t in s[0]){n=t;return true}return false})}if(e){var a=function(t){return(t==null?"":t).toString().padStart(5,"0")};s=s.filter(function(t){return a(t[n])===e})}o.getModel("solpedHeader").setData(i);o.getModel("solpedItems").setData(s);o.getModel("solpedHeader").refresh(true);o.getModel("solpedItems").refresh(true);this._applyItemFilterByPos(e,n);o.setBusy(false);if(!s.length){sap.m.MessageToast.show("No se encontraron posiciones para la SOLPED "+t+(e?" (pos. "+e+")":""))}}.bind(this)).catch(function(t){o.setBusy(false);if(i){sap.base.Log.warning("Outbox: lectura SOLPED falló o incompleta",t);sap.m.MessageToast.show("No fue posible recuperar el detalle completo de la SOLPED (Outbox).")}else{var e="Error cargando datos de SOLPED";if(t&&t.message){e+=": "+t.message}sap.m.MessageBox.error(e);sap.base.Log.error("Error en _loadSolped",t)}})},onItemsUpdateFinished:function(t){var e=t.getParameter("total");if(e<0){var o=this.byId("tblItems").getBinding("items");e=o?o.getLength():0}this.byId("posTitle").setText("Posiciones ("+e+")")},_getAttrCI:function(t){var e=this.getView().getModel("detail").getProperty("/CustomAttributeData");if(!Array.isArray(e)){if(e&&Array.isArray(e.results)){e=e.results}else{e=[]}}var o=String(t||"").toLowerCase();for(var r=0;r<e.length;r++){var i=String(e[r].Name||"").toLowerCase();if(i===o)return e[r].Value||""}return""},_getKeysFromTask:function(t){var e=this._getAttrCI("BANFN")||this._getAttrCI("Solped");var o=this._getAttrCI("BNFPO")||this._getAttrCI("Posicion")||this._getAttrCI("EBELP");var r=String(t||"").match(/\d+/g)||[];if(!e){e=r.find(function(t){return t.length>=7&&t.length<=10})||""}if(!o){for(var i=r.length-1;i>=0;i--){if(r[i].length===5){o=r[i];break}}}if(o){o=o.toString().padStart(5,"0")}return{banfn:e,bnfpo:o}},_applyItemFilterByPos:function(t,e){var o=this.byId("tblItems");if(!o)return;var r=o.getBinding("items");if(!r)return;if(t){var i=function(t){return(t==null?"":t).toString().padStart(5,"0")};var s=new sap.ui.model.Filter({path:e||"Posicion",test:function(e){return i(e)===t}});r.filter([s],"Application")}else{r.filter([],"Application")}},_isOutboxMode:function(){try{var t=sap.ui.core.routing.HashChanger.getInstance().getHash()||"";if(t.indexOf("WorkflowTask-displayOutbox")>-1||/[?&]outbox=true\b/.test(t)){return true}var e=(this.getOwnerComponent().getComponentData()||{}).startupParameters||{};if(e.outbox&&String(e.outbox[0]).toLowerCase()==="true")return true}catch(t){}return false},_normBanfn:function(t){if(t==null)return"";t=String(t).trim();return t.padStart(10,"0")},_getBanfnPath:function(t,e,o){var r=this._normBanfn(o);return`/${e}('${encodeURIComponent(r)}')`},_getSolpedFromObjectLinks:function(){try{var t=this.getView().getModel("detail").getProperty("/ObjectLinks");if(!t)return"";var e=JSON.stringify(t);var o=e.match(/\b\d{7,10}\b/g);return o&&o[0]||""}catch(t){return""}},_getKeysFromTask:function(t){var e=this._getAttrCI("BANFN")||this._getAttrCI("Solped")||this._getSolpedFromObjectLinks();var o=this._getAttrCI("BNFPO")||this._getAttrCI("Posicion")||this._getAttrCI("EBELP");var r=String(t||"").match(/\d+/g)||[];if(!e){e=r.find(function(t){return t.length>=7&&t.length<=10})||""}if(!o){for(var i=r.length-1;i>=0;i--){if(r[i].length===5){o=r[i];break}}}if(o){o=o.toString().padStart(5,"0")}if(e){e=this._normBanfn(e)}return{banfn:e,bnfpo:o}}})});
//# sourceMappingURL=S3Custom.controller.js.map